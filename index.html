<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>METAR Traduzido</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      padding: 30px;
      max-width: 800px;
      margin: auto;
    }
    h1 {
      color: #333;
    }
    input, button {
      padding: 10px;
      font-size: 16px;
      margin-top: 10px;
    }
    #metar, #traducao {
      margin-top: 20px;
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 0 10px #ccc;
    }
    #traducao {
      background: #e8f5e9;
    }
  </style>
</head>
<body>
  <h1>Consulta METAR com Tradução</h1>
  <label for="icao">Código ICAO do aeroporto:</label><br>
  <input type="text" id="icao" value="LPPT" />
  <button onclick="getMetar()">Buscar METAR</button>

  <div id="metar">Insira um código ICAO e clique em "Buscar METAR".</div>
  <div id="traducao"></div>

  <script>
    async function getMetar() {
      const icao = document.getElementById('icao').value.toUpperCase();
      const targetUrl = `https://aviationweather.gov/cgi-bin/data/dataserver.php?dataSource=metars&requestType=retrieve&format=xml&hoursBeforeNow=1&stationString=${icao}`;
      const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}`;

      try {
        const response = await fetch(proxyUrl);
        const data = await response.json();
        const xml = data.contents;
        const match = xml.match(/<raw_text>(.*?)<\/raw_text>/);
        const metar = match ? match[1] : "METAR não encontrado.";
        document.getElementById('metar').innerText = metar;
        document.getElementById('traducao').innerText = traduzirMetar(metar);
      } catch (error) {
        document.getElementById('metar').innerText = "Erro ao buscar dados.";
        document.getElementById('traducao').innerText = "";
        console.error("Erro:", error);
      }
    }

    function traduzirMetar(metar) {
      if (!metar || metar === "METAR não encontrado.") return "";

      const partes = metar.split(" ");
      let resultado = [];

      partes.forEach(p => {
        if (/^\d{6}Z$/.test(p)) {
          resultado.push(`Observado às ${p.slice(2,4)}:${p.slice(4,6)} UTC no dia ${p.slice(0,2)}.`);
        } else if (/^\d{3}\d{2}G\d{2}KT$/.test(p)) {
          const direcao = p.slice(0,3);
          const vel = p.slice(3,5);
          const rajada = p.slice(6,8);
          resultado.push(`Vento de ${direcao}° a ${vel} nós com rajadas de ${rajada} nós.`);
        } else if (/^VRB\d{2}KT$/.test(p)) {
          const velocidade = p.slice(3,5);
          resultado.push(`Vento variável a ${velocidade} nós.`);
        } else if (/^\d{3}\d{2}KT$/.test(p)) {
          const direcao = p.slice(0,3);
          const velocidade = p.slice(3,5);
          resultado.push(`Vento de ${direcao}° a ${velocidade} nós.`);
        } else if (/^\d{4}$/.test(p)) {
          resultado.push(`Visibilidade de ${parseInt(p)} metros.`);
        } else if (/^CAVOK$/.test(p)) {
          resultado.push(`Céu limpo, visibilidade superior a 10 km, sem nuvens significativas ou fenômenos.`);
        } else if (/^(FEW|SCT|BKN|OVC)\d{3}$/.test(p)) {
          const cobertura = { FEW: "Poucas nuvens", SCT: "Nuvens dispersas", BKN: "Nuvens fragmentadas", OVC: "Céu encoberto" };
          const tipo = p.slice(0,3);
          const altura = parseInt(p.slice(3)) * 100;
          resultado.push(`${cobertura[tipo]} a ${altura} pés.`);
        } else if (/^Q\d{4}$/.test(p)) {
          resultado.push(`Pressão atmosférica de ${p.slice(1)} hPa.`);
        } else if (/^(-|\+)?(RA|SN|FG|BR|HZ|TS|DZ|GR)$/.test(p)) {
          const intensidade = p.startsWith("+") ? "forte" : p.startsWith("-") ? "fraca" : "moderada";
          const fenomeno = {
            RA: "chuva", SN: "neve", FG: "nevoeiro", BR: "névoa",
            HZ: "névoa seca", TS: "trovoada", DZ: "chuvisco", GR: "granizo"
          }[p.replace(/[-+]/, "")];
          resultado.push(`${fenomeno.charAt(0).toUpperCase() + fenomeno.slice(1)} ${intensidade}.`);
        } else if (/^\d{2}\/\d{2}$/.test(p)) {
          const [temp, dew] = p.split("/");
          resultado.push(`Temperatura: ${temp}°C, Ponto de orvalho: ${dew}°C.`);
        } else if (/^R\d{2}[A-Z]?\/\d{4}$/.test(p)) {
          resultado.push(`Alcance visual na pista: ${p}.`);
        } else if (/^NOSIG$/.test(p)) {
          resultado.push(`Sem mudanças significativas esperadas.`);
        } else if (/^(BECMG|TEMPO)$/.test(p)) {
          resultado.push(`Tendência: ${p === "BECMG" ? "Mudança gradual esperada" : "Condições temporárias previstas"}.`);
        }
      });

      return resultado.join(" ");
    }
  </script>
</body>
</html>
