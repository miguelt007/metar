<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Painel METAR/TAF/SIGMET</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #1e1e2f;
      color: #fff;
      padding: 30px;
      margin: 0;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    .input-area {
      text-align: center;
      margin-bottom: 20px;
    }
    input, button {
      padding: 10px;
      font-size: 16px;
      margin: 5px;
      border-radius: 5px;
      border: none;
    }
    button {
      background-color: #0078d7;
      color: white;
      cursor: pointer;
    }
    .panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .card {
      background: #2e2e3e;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px #000;
      transition: background 0.3s ease;
    }
    .card.severe {
      background: #8b0000;
      color: #fff;
      border: 2px solid #ff4c4c;
    }
    .card h2 {
      margin-top: 0;
      font-size: 18px;
    }
    .card span {
      font-size: 16px;
      display: block;
      margin-top: 10px;
      white-space: pre-wrap;
    }
    #metarRaw {
      text-align: center;
      font-style: italic;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>Painel de Controle METAR / TAF / SIGMET</h1>
  <div class="input-area">
    <input type="text" id="icao" value="LPPT" placeholder="C√≥digo ICAO" />
    <button onclick="getMetar()">Buscar</button>
  </div>

  <div id="metarRaw"></div>
  <div class="panel" id="metarPanel"></div>

  <script>
    async function getMetar() {
      const icao = document.getElementById('icao').value.toUpperCase();
      const baseUrl = "https://aviationweather.gov/cgi-bin/data/dataserver.php";
      const proxy = url => `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;

      const endpoints = {
        metar: `${baseUrl}?dataSource=metars&requestType=retrieve&format=xml&hoursBeforeNow=1&stationString=${icao}`,
        taf: `${baseUrl}?dataSource=tafs&requestType=retrieve&format=xml&hoursBeforeNow=1&stationString=${icao}`,
        sigmet: `${baseUrl}?dataSource=sigmets&requestType=retrieve&format=xml&hoursBeforeNow=4`
      };

      try {
        const [metarRes, tafRes, sigmetRes] = await Promise.all([
          fetch(proxy(endpoints.metar)).then(r => r.json()),
          fetch(proxy(endpoints.taf)).then(r => r.json()),
          fetch(proxy(endpoints.sigmet)).then(r => r.json())
        ]);

        const metarText = metarRes.contents.match(/<raw_text>(.*?)<\/raw_text>/)?.[1] || "METAR n√£o encontrado.";
        const tafText = tafRes.contents.match(/<raw_text>(.*?)<\/raw_text>/)?.[1] || "TAF n√£o encontrado.";
        const sigmetMatches = [...sigmetRes.contents.matchAll(/<raw_text>(.*?)<\/raw_text>/g)];
        const sigmetTexts = sigmetMatches.map(m => m[1]);

        document.getElementById('metarRaw').innerText = metarText;
        renderPanel(metarText);
        renderTAF(tafText);
        renderSIGMET(sigmetTexts);
      } catch (error) {
        document.getElementById('metarRaw').innerText = "Erro ao buscar dados.";
        console.error("Erro:", error);
      }
    }

    function renderPanel(metar) {
      const partes = metar.split(" ");
      const panel = document.getElementById('metarPanel');
      panel.innerHTML = "";

      partes.forEach(p => {
        let titulo = "", valor = "", severo = false;

        if (/^\d{6}Z$/.test(p)) {
          titulo = "üïí Hora da Observa√ß√£o";
          valor = `${p.slice(0,2)}/${p.slice(2,4)}:${p.slice(4,6)} UTC`;
        } else if (/^\d{3}\d{2}G\d{2}KT$/.test(p)) {
          const direcao = p.slice(0,3);
          const vel = parseInt(p.slice(3,5));
          const rajada = parseInt(p.slice(6,8));
          titulo = "üí® Vento com Rajadas";
          valor = `${direcao}¬∞ a ${vel} n√≥s, rajadas de ${rajada} n√≥s`;
          severo = rajada > 25;
        } else if (/^VRB\d{2}KT$/.test(p)) {
          const velocidade = parseInt(p.slice(3,5));
          titulo = "üí® Vento Vari√°vel";
          valor = `${velocidade} n√≥s`;
          severo = velocidade > 30;
        } else if (/^\d{3}\d{2}KT$/.test(p)) {
          const direcao = p.slice(0,3);
          const velocidade = parseInt(p.slice(3,5));
          titulo = "üí® Vento";
          valor = `${direcao}¬∞ a ${velocidade} n√≥s`;
          severo = velocidade > 30;
        } else if (/^\d{4}$/.test(p)) {
          const vis = parseInt(p);
          titulo = "üëÅÔ∏è Visibilidade";
          valor = `${vis} metros`;
          severo = vis < 1000;
        } else if (/^(FEW|SCT|BKN|OVC)\d{3}$/.test(p)) {
          const cobertura = { FEW: "Poucas nuvens", SCT: "Dispersas", BKN: "Fragmentadas", OVC: "Encoberto" };
          const tipo = p.slice(0,3);
          const altura = parseInt(p.slice(3)) * 100;
          titulo = "‚òÅÔ∏è Nuvens";
          valor = `${cobertura[tipo]} a ${altura} p√©s`;
        } else if (/^Q\d{4}$/.test(p)) {
          titulo = "üìâ Press√£o";
          valor = `${p.slice(1)} hPa`;
        } else if (/^\d{2}\/\d{2}$/.test(p)) {
          const [temp, dew] = p.split("/");
          titulo = "üå°Ô∏è Temperatura";
          valor = `${temp}¬∞C / Ponto de orvalho: ${dew}¬∞C`;
        } else if (/^(-|\+)?(RA|SN|FG|BR|HZ|TS|DZ|GR)$/.test(p)) {
          const intensidade = p.startsWith("+") ? "forte" : p.startsWith("-") ? "fraca" : "moderada";
          const fenomeno = {
            RA: "chuva", SN: "neve", FG: "nevoeiro", BR: "n√©voa",
            HZ: "n√©voa seca", TS: "trovoada", DZ: "chuvisco", GR: "granizo"
          }[p.replace(/[-+]/, "")];
          titulo = "üåßÔ∏è Fen√¥meno";
          valor = `${fenomeno} ${intensidade}`;
          severo = p.startsWith("+") || ["TS", "GR", "FG", "SN"].includes(p.replace(/[-+]/, ""));
        } else if (/^NOSIG$/.test(p)) {
          titulo = "üîÆ Tend√™ncia";
          valor = "Sem mudan√ßas significativas";
        } else if (/^CAVOK$/.test(p)) {
          titulo = "üå§Ô∏è Condi√ß√µes";
          valor = "C√©u limpo, visibilidade >10km";
        }

        if (titulo) {
          const div = document.createElement("div");
          div.className = "card" + (severo ? " severe" : "");
          div.innerHTML = `<h2>${titulo}</h2><span>${valor}</span>`;
          panel.appendChild(div);
        }
      });
    }

    function renderTAF(tafRaw) {
      const panel = document.getElementById('metarPanel');
      const tafParts = tafRaw.split(/\s+/);
      let output = [];

      tafParts.forEach((p, i) => {
        if (/^\d{6}Z$/.test(p)) {
          output.push(`üìÖ Emitido √†s ${p.slice(2,4)}:${p.slice(4,6)} UTC no dia ${p.slice(0,2)}.`);
        } else if (/^\d{4}\/\d{4}$/.test(p)) {
          output.push(`‚è≥ V√°lido de ${p.slice(0,2)}/${p.slice(2,4)} at√© ${p.slice(5,7)}/${p.slice(7,9)} UTC.`);
        } else if (/^\d{3}\d{2}KT$/.test(p)) {
          output.push(`üí® Vento previsto: ${p.slice(0,3)}¬∞ a ${p.slice(3,5)} n√≥s.`);
        } else if (/^CAVOK$/.test(p)) {
          output.push(`üå§Ô∏è C√©u limpo, visibilidade >10km.`);
        } else if (/^(BECMG|TEMPO|FM|PROB\d{2})$/.test(p)) {
          const label = { BECMG: "Mudan√ßa gradual esperada", TEMPO: "Condi√ß√µes tempor√°rias", FM: "A partir de", PROB: "Probabilidade" };
          output.push(`üîÑ ${label[p] || p}`);
        } else if (/^\d{4}$/.test(p)) {
          output.push(`üëÅÔ∏è Visibilidade prevista: ${p} metros.`);
        } else if (/^(FEW|SCT|BKN|OVC)\d{3}$/.test(p)) {
          const cobertura = { FEW: "Poucas nuvens", SCT: "Dispersas", BKN: "Fragmentadas", OVC: "Encoberto" };
          const tipo = p.slice(0,3);
          const altura = parseInt(p.slice(3)) * 100;
          output.push(`‚òÅÔ∏è ${cobertura[tipo]} a ${altura} p√©s.`);
        } else if (/^(-|\+)?(RA|SN|FG|BR|HZ|TS|DZ|GR)$/.test(p)) {
          const intensidade = p.startsWith("+") ? "forte" : p.startsWith("-") ? "fraca" : "moderada";
          const fenomeno = {
            RA: "chuva", SN: "neve", FG: "nevoeiro", BR: "n√©voa",
            HZ: "n√©voa seca", TS: "trovoada", DZ: "chuvisco", GR: "granizo"
          }[p.replace(/[-+]/, "")];
          output.push(`üåßÔ∏è ${fenomeno} ${intensidade}.`);
        }
      });

      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `<h2>üìã TAF - Previs√£o</h2><span>${output.join("\n")}</span>`;
      panel.appendChild(div);
    }

    function renderSIGMET(sigmetList) {
      const panel = document.getElementById('metarPanel');
      if (sigmetList.length === 0) return;

      sigmetList.forEach((sig, i) => {
        const div = document.createElement("div");
        div.className = "card severe";
        div.innerHTML = `<h2>‚ö†Ô∏è SIGMET ${i + 1}</h2><span>${sig}</span>`;
        panel.appendChild(div);
      });
    }
  </script>
</body>
</html>
