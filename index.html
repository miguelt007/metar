<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Painel METAR</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #1e1e2f;
      color: #fff;
      padding: 30px;
      margin: 0;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    .input-area {
      text-align: center;
      margin-bottom: 20px;
    }
    input, button {
      padding: 10px;
      font-size: 16px;
      margin: 5px;
      border-radius: 5px;
      border: none;
    }
    button {
      background-color: #0078d7;
      color: white;
      cursor: pointer;
    }
    .panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .card {
      background: #2e2e3e;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px #000;
    }
    .card h2 {
      margin-top: 0;
      font-size: 18px;
    }
    .card span {
      font-size: 24px;
      display: block;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>Painel de Controle METAR</h1>
  <div class="input-area">
    <input type="text" id="icao" value="LPPT" placeholder="CÃ³digo ICAO" />
    <button onclick="getMetar()">Buscar</button>
  </div>

  <div id="metarRaw" style="text-align:center;"></div>
  <div class="panel" id="metarPanel"></div>

  <script>
    async function getMetar() {
      const icao = document.getElementById('icao').value.toUpperCase();
      const targetUrl = `https://aviationweather.gov/cgi-bin/data/dataserver.php?dataSource=metars&requestType=retrieve&format=xml&hoursBeforeNow=1&stationString=${icao}`;
      const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}`;

      try {
        const response = await fetch(proxyUrl);
        const data = await response.json();
        const xml = data.contents;
        const match = xml.match(/<raw_text>(.*?)<\/raw_text>/);
        const metar = match ? match[1] : "METAR nÃ£o encontrado.";
        document.getElementById('metarRaw').innerText = metar;
        renderPanel(metar);
      } catch (error) {
        document.getElementById('metarRaw').innerText = "Erro ao buscar dados.";
        document.getElementById('metarPanel').innerHTML = "";
        console.error("Erro:", error);
      }
    }

    function renderPanel(metar) {
      const partes = metar.split(" ");
      const panel = document.getElementById('metarPanel');
      panel.innerHTML = "";

      partes.forEach(p => {
        if (/^\d{6}Z$/.test(p)) {
          addCard("ðŸ•’ Hora da ObservaÃ§Ã£o", `${p.slice(0,2)}/${p.slice(2,4)}:${p.slice(4,6)} UTC`);
        } else if (/^\d{3}\d{2}KT$/.test(p)) {
          addCard("ðŸ’¨ Vento", `${p.slice(0,3)}Â° a ${p.slice(3,5)} nÃ³s`);
        } else if (/^VRB\d{2}KT$/.test(p)) {
          addCard("ðŸ’¨ Vento VariÃ¡vel", `${p.slice(3,5)} nÃ³s`);
        } else if (/^\d{4}$/.test(p)) {
          addCard("ðŸ‘ï¸ Visibilidade", `${p} metros`);
        } else if (/^(FEW|SCT|BKN|OVC)\d{3}$/.test(p)) {
          const cobertura = { FEW: "Poucas nuvens", SCT: "Dispersas", BKN: "Fragmentadas", OVC: "Encoberto" };
          const tipo = p.slice(0,3);
          const altura = parseInt(p.slice(3)) * 100;
          addCard("â˜ï¸ Nuvens", `${cobertura[tipo]} a ${altura} pÃ©s`);
        } else if (/^Q\d{4}$/.test(p)) {
          addCard("ðŸ“‰ PressÃ£o", `${p.slice(1)} hPa`);
        } else if (/^\d{2}\/\d{2}$/.test(p)) {
          const [temp, dew] = p.split("/");
          addCard("ðŸŒ¡ï¸ Temperatura", `${temp}Â°C / Ponto de orvalho: ${dew}Â°C`);
        } else if (/^(-|\+)?(RA|SN|FG|BR|HZ|TS|DZ|GR)$/.test(p)) {
          const intensidade = p.startsWith("+") ? "forte" : p.startsWith("-") ? "fraca" : "moderada";
          const fenomeno = {
            RA: "chuva", SN: "neve", FG: "nevoeiro", BR: "nÃ©voa",
            HZ: "nÃ©voa seca", TS: "trovoada", DZ: "chuvisco", GR: "granizo"
          }[p.replace(/[-+]/, "")];
          addCard("ðŸŒ§ï¸ FenÃ´meno", `${fenomeno} ${intensidade}`);
        } else if (/^NOSIG$/.test(p)) {
          addCard("ðŸ”® TendÃªncia", "Sem mudanÃ§as significativas");
        } else if (/^CAVOK$/.test(p)) {
          addCard("ðŸŒ¤ï¸ CondiÃ§Ãµes", "CÃ©u limpo, visibilidade >10km");
        }
      });

      function addCard(titulo, valor) {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `<h2>${titulo}</h2><span>${valor}</span>`;
        panel.appendChild(div);
      }
    }
  </script>
</body>
</html>
