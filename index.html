<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Painel METAR</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #1e1e2f;
      color: #fff;
      padding: 30px;
      margin: 0;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    .input-area {
      text-align: center;
      margin-bottom: 20px;
    }
    input, button {
      padding: 10px;
      font-size: 16px;
      margin: 5px;
      border-radius: 5px;
      border: none;
    }
    button {
      background-color: #0078d7;
      color: white;
      cursor: pointer;
    }
    .panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .card {
      background: #2e2e3e;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px #000;
      transition: background 0.3s ease;
    }
    .card.severe {
      background: #8b0000;
      color: #fff;
      border: 2px solid #ff4c4c;
    }
    .card h2 {
      margin-top: 0;
      font-size: 18px;
    }
    .card span {
      font-size: 24px;
      display: block;
      margin-top: 10px;
    }
    #metarRaw {
      text-align: center;
      font-style: italic;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>Painel de Controle METAR</h1>
  <div class="input-area">
    <input type="text" id="icao" value="LPPT" placeholder="C√≥digo ICAO" />
    <button onclick="getMetar()">Buscar</button>
  </div>

  <div id="metarRaw"></div>
  <div class="panel" id="metarPanel"></div>

  <script>
    async function getMetar() {
      const icao = document.getElementById('icao').value.toUpperCase();
      const targetUrl = `https://aviationweather.gov/cgi-bin/data/dataserver.php?dataSource=metars&requestType=retrieve&format=xml&hoursBeforeNow=1&stationString=${icao}`;
      const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}`;

      try {
        const response = await fetch(proxyUrl);
        const data = await response.json();
        const xml = data.contents;
        const match = xml.match(/<raw_text>(.*?)<\/raw_text>/);
        const metar = match ? match[1] : "METAR n√£o encontrado.";
        document.getElementById('metarRaw').innerText = metar;
        renderPanel(metar);
      } catch (error) {
        document.getElementById('metarRaw').innerText = "Erro ao buscar dados.";
        document.getElementById('metarPanel').innerHTML = "";
        console.error("Erro:", error);
      }
    }

    function renderPanel(metar) {
      const partes = metar.split(" ");
      const panel = document.getElementById('metarPanel');
      panel.innerHTML = "";

      partes.forEach(p => {
        let titulo = "", valor = "", severo = false;

        if (/^\d{6}Z$/.test(p)) {
          titulo = "üïí Hora da Observa√ß√£o";
          valor = `${p.slice(0,2)}/${p.slice(2,4)}:${p.slice(4,6)} UTC`;
        } else if (/^\d{3}\d{2}G\d{2}KT$/.test(p)) {
          const direcao = p.slice(0,3);
          const vel = parseInt(p.slice(3,5));
          const rajada = parseInt(p.slice(6,8));
          titulo = "üí® Vento com Rajadas";
          valor = `${direcao}¬∞ a ${vel} n√≥s, rajadas de ${rajada} n√≥s`;
          severo = rajada > 25;
        } else if (/^VRB\d{2}KT$/.test(p)) {
          const velocidade = parseInt(p.slice(3,5));
          titulo = "üí® Vento Vari√°vel";
          valor = `${velocidade} n√≥s`;
          severo = velocidade > 30;
        } else if (/^\d{3}\d{2}KT$/.test(p)) {
          const direcao = p.slice(0,3);
          const velocidade = parseInt(p.slice(3,5));
          titulo = "üí® Vento";
          valor = `${direcao}¬∞ a ${velocidade} n√≥s`;
          severo = velocidade > 30;
        } else if (/^\d{4}$/.test(p)) {
          const vis = parseInt(p);
          titulo = "üëÅÔ∏è Visibilidade";
          valor = `${vis} metros`;
          severo = vis < 1000;
        } else if (/^(FEW|SCT|BKN|OVC)\d{3}$/.test(p)) {
          const cobertura = { FEW: "Poucas nuvens", SCT: "Dispersas", BKN: "Fragmentadas", OVC: "Encoberto" };
          const tipo = p.slice(0,3);
          const altura = parseInt(p.slice(3)) * 100;
          titulo = "‚òÅÔ∏è Nuvens";
          valor = `${cobertura[tipo]} a ${altura} p√©s`;
        } else if (/^Q\d{4}$/.test(p)) {
          titulo = "üìâ Press√£o";
          valor = `${p.slice(1)} hPa`;
        } else if (/^\d{2}\/\d{2}$/.test(p)) {
          const [temp, dew] = p.split("/");
          titulo = "üå°Ô∏è Temperatura";
          valor = `${temp}¬∞C / Ponto de orvalho: ${dew}¬∞C`;
        } else if (/^(-|\+)?(RA|SN|FG|BR|HZ|TS|DZ|GR)$/.test(p)) {
          const intensidade = p.startsWith("+") ? "forte" : p.startsWith("-") ? "fraca" : "moderada";
          const fenomeno = {
            RA: "chuva", SN: "neve", FG: "nevoeiro", BR: "n√©voa",
            HZ: "n√©voa seca", TS: "trovoada", DZ: "chuvisco", GR: "granizo"
          }[p.replace(/[-+]/, "")];
          titulo = "üåßÔ∏è Fen√¥meno";
          valor = `${fenomeno} ${intensidade}`;
          severo = p.startsWith("+") || ["TS", "GR", "FG", "SN"].includes(p.replace(/[-+]/, ""));
        } else if (/^NOSIG$/.test(p)) {
          titulo = "üîÆ Tend√™ncia";
          valor = "Sem mudan√ßas significativas";
        } else if (/^CAVOK$/.test(p)) {
          titulo = "üå§Ô∏è Condi√ß√µes";
          valor = "C√©u limpo, visibilidade >10km";
        }

        if (titulo) {
          const div = document.createElement("div");
          div.className = "card" + (severo ? " severe" : "");
          div.innerHTML = `<h2>${titulo}</h2><span>${valor}</span>`;
          panel.appendChild(div);
        }
      });
    }
  </script>
</body>
</html>
