<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Painel METAR / TAF</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; padding: 20px; margin: auto; max-width: 800px; }
    h1 { color: #333; font-size: 1.8em; text-align: center; }
    select { font-size: 16px; padding: 8px; margin-top: 10px; width: 100%; max-width: 400px; }
    .section { margin-top: 30px; }
    pre { background: #fff; padding: 12px; border: 1px solid #ccc; white-space: pre-wrap; word-wrap: break-word; font-size: 15px; }
    .timestamp { font-size: 14px; color: #666; margin-top: 5px; }
    @media (max-width: 600px) {
      body { padding: 10px; }
      h1 { font-size: 1.4em; }
      select { font-size: 15px; }
      pre { font-size: 14px; }
    }
  </style>
</head>
<body>
  <h1>üõ´ Painel METAR / TAF</h1>

  <label for="icao">Seleciona o aeroporto:</label>
  <select id="icao"></select>

  <div class="section">
    <h2>üõ¨ METAR</h2>
    <pre id="metar">Selecione um aeroporto acima.</pre>
    <div class="timestamp" id="metar-time"></div>
  </div>

  <div class="section">
    <h2>üîç Descodifica√ß√£o METAR</h2>
    <pre id="metar-decode">Aguarde...</pre>
  </div>

  <div class="section">
    <h2>üìã TAF</h2>
    <pre id="taf">Selecione um aeroporto acima.</pre>
    <div class="timestamp" id="taf-time"></div>
  </div>

  <div class="section">
    <h2>üîç Descodifica√ß√£o TAF</h2>
    <pre id="taf-decode">Aguarde...</pre>
  </div>

  <script>
    let nomesICAO = {};

    async function carregarListaICAO() {
      try {
        const [listaRes, nomesRes] = await Promise.all([
          fetch("dados/icao-lista.json?" + Date.now()),
          fetch("dados/icao-nomes.json?" + Date.now())
        ]);

        const lista = await listaRes.json();
        nomesICAO = await nomesRes.json();

        const select = document.getElementById("icao");
        select.innerHTML = "";

        lista.forEach(icao => {
          const opt = document.createElement("option");
          opt.value = icao;
          opt.textContent = `${icao} - ${nomesICAO[icao] || "Desconhecido"}`;
          select.appendChild(opt);
        });

        select.onchange = () => carregarDados(select.value);
        carregarDados(lista[0]);
      } catch (error) {
        console.error("Erro ao carregar ICAOs ou nomes:", error);
        document.getElementById("icao").innerHTML = "<option>Erro ao carregar ICAOs</option>";
      }
    }

    async function carregarDados(icao) {
      const cacheBuster = Date.now();

      try {
        const [metarRes, tafRes] = await Promise.all([
          fetch(`dados/metar-${icao}.json?${cacheBuster}`),
          fetch(`dados/taf-${icao}.json?${cacheBuster}`)
        ]);

        const metarData = await metarRes.json();
        const tafData = await tafRes.json();

        const metarTexto = metarData.metar?.trim();
        const tafTexto = tafData.taf?.trim();

        if (metarTexto && !metarTexto.toLowerCase().includes("n√£o dispon√≠vel")) {
          document.getElementById("metar").textContent = metarTexto;
          document.getElementById("metar-time").textContent = metarData.updated || "";
          document.getElementById("metar-decode").textContent = descodificarMETAR(metarTexto);
        } else {
          document.getElementById("metar").textContent = "‚ö†Ô∏è Dados n√£o encontrados.";
          document.getElementById("metar-time").textContent = "";
          document.getElementById("metar-decode").textContent = "";
        }

        if (tafTexto && !tafTexto.toLowerCase().includes("n√£o dispon√≠vel")) {
          document.getElementById("taf").textContent = tafTexto;
          document.getElementById("taf-time").textContent = tafData.updated || "";
          document.getElementById("taf-decode").textContent = descodificarTAF(tafTexto);
        } else {
          document.getElementById("taf").textContent = "‚ö†Ô∏è Dados n√£o encontrados.";
          document.getElementById("taf-time").textContent = "";
          document.getElementById("taf-decode").textContent = "";
        }

      } catch (error) {
        console.error("Erro ao carregar dados:", error);
      }
    }

    function descodificarMETAR(metar) {
      if (!metar) return "";

      let texto = metar
        .replace(/(\d{2})(\d{4})Z/, "Observa√ß√£o do dia $1 √†s $2 UTC")
        .replace(/VRB(\d{2})KT/, "Vento vari√°vel a $1 n√≥s")
        .replace(/(\d{3})(\d{2})KT/, "Vento: $1¬∞ a $2 n√≥s")
        .replace(/(\d{3})V(\d{3})/, "Varia√ß√£o de vento entre $1¬∞ e $2¬∞")
        .replace(/9999/, "Visibilidade ‚â•10 km")
        .replace(/(\d{2})\/(\d{2})/, "Temperatura: $1¬∞C / Ponto de orvalho: $2¬∞C")
        .replace(/Q(\d{4})/, "Press√£o: $1 hPa")
        .replace(/(FEW|SCT|BKN|OVC)(\d{3})/g, (_, tipo, altura) => {
          const mapa = {
            FEW: "Poucas nuvens",
            SCT: "Nuvens dispersas",
            BKN: "Nuvens fragmentadas",
            OVC: "Cobertura total de nuvens"
          };
          const altitude = parseInt(altura, 10) * 100;
          return `${mapa[tipo]} a ${altitude} p√©s`;
        });

      const rmkMatch = metar.match(/RMK (.+)/);
      if (rmkMatch) {
        texto += `\nObserva√ß√µes (RMK): ${descodificarRMK(rmkMatch[1])}`;
      }

      return texto;
    }

    function descodificarRMK(rmk) {
      return rmk
        .replace(/WIND RWY(\d{2}) (\d{3})(\d{2})KT (\d{3})V(\d{3})/g,
          (_, pista, dir, vel, var1, var2) =>
            `Vento na pista ${pista}: ${dir}¬∞ a ${vel} n√≥s, variando entre ${var1}¬∞ e ${var2}¬∞`)
        .replace(/WIND RWY(\d{2}) (\d{3})(\d{2})KT/g,
          (_, pista, dir, vel) =>
            `Vento na pista ${pista}: ${dir}¬∞ a ${vel} n√≥s`);
    }

    function descodificarTAF(taf) {
      if (!taf) return "";

      return taf
        .replace(/TAF\s+(\w+)/, "Previs√£o para: $1")
        .replace(/(\d{6})Z/, "Emitido √†s: $1 UTC")
        .replace(/(\d{4})\/(\d{4})/, "V√°lido de: $1 at√© $2 UTC")
        .replace(/FM(\d{6})/, "A partir de: $1 UTC")
        .replace(/BECMG (\d{4}\/\d{4})/, "Tend√™ncia: $1")
        .replace(/TEMPO (\d{4}\/\d{4})/, "Condi√ß√µes tempor√°rias: $1")
        .replace(/PROB(\d{2}) (\d{4}\/\d{4})/, "Probabilidade $1% entre $2")
        .replace(/NSW/, "Sem fen√≥menos significativos (NSW)")
        .replace(/TX(\d{2})\/(\d{4})Z/, "Temp m√°xima: $1¬∞C √†s $2 UTC")
        .replace(/TN(\d{2})\/(\d{4})Z/, "Temp m√≠nima: $1¬∞C √†s $2 UTC")
        .replace(/VRB(\d{2})KT/, "Vento vari√°vel a $1 n√≥s")
        .replace(/(\d{3})(\d{2})KT/, "Vento: $1¬∞ a $2 n√≥s")
        .replace(/9999/, "Visibilidade ‚â•10 km")
        .replace(/CAVOK/, "Condi√ß√µes visuais excelentes (CAVOK)")
        .replace(/(FEW|SCT|BKN|OVC)(\d{3})/g, (_, tipo, altura) => {
          const mapa = {
            FEW: "Poucas nuvens",
            SCT: "Nuvens dispersas",
            BKN: "Nuvens fragmentadas",
            OVC: "Cobertura total de nuvens"
          };
          const altitude = parseInt(altura, 10) * 100;
          return `${mapa[tipo]} a ${altitude} p√©s`;
        });
    }

    carregarListaICAO();
  </script>
</body>
</html>
