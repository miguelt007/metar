name: Atualizar METAR/TAF

on:
  schedule:
    - cron: '0 * * * *'  # corre de hora a hora
  workflow_dispatch:

jobs:
  atualizar:
    runs-on: ubuntu-latest

    steps:
      - name: Clonar reposit√≥rio
        uses: actions/checkout@v3

      - name: Atualizar ficheiros JSON existentes
        run: |
          echo "üìÅ Conte√∫do atual da pasta dados:"
          mkdir -p dados
          ls -lh dados/ || true

          ICAOS="LPPT LPFR LPPR LPCS LPMR LPPD LPLA LPAZ LPSJ LPPS LPMA KJFK KLAX KORD"

          for ICAO in $ICAOS; do
            echo "üîÑ A atualizar $ICAO..."

            METAR=$(curl -s "https://tgftp.nws.noaa.gov/data/observations/metar/stations/${ICAO}.TXT" | tail -n1 || true)
            TAF=$(curl -s "https://tgftp.nws.noaa.gov/data/forecasts/taf/stations/${ICAO}.TXT" | grep "^TAF" || true)

            [ -z "$METAR" ] && METAR="METAR n√£o dispon√≠vel para ${ICAO}"
            [ -z "$TAF" ] && TAF="TAF n√£o dispon√≠vel para ${ICAO}"

            TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

            echo "üìÑ METAR para $ICAO: $METAR"
            echo "üìÑ TAF para $ICAO: $TAF"
            echo "üïí Timestamp: $TIMESTAMP"

            echo "{\"icao\":\"$ICAO\",\"metar\":\"$METAR\",\"updated\":\"$TIMESTAMP\"}" > dados/metar-$ICAO.json
            echo "{\"icao\":\"$ICAO\",\"taf\":\"$TAF\",\"updated\":\"$TIMESTAMP\"}" > dados/taf-$ICAO.json
          done

          echo "üß© Gerando lista de ICAOs dispon√≠veis..."
          ICAO_LIST=$(ls dados/metar-*.json | sed 's|dados/metar-||;s|\.json||' | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "$ICAO_LIST" > dados/icao-lista.json
          echo "‚úÖ ICAOs dispon√≠veis: $ICAO_LIST"

      - name: Commit e push autom√°tico
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Atualiza√ß√£o autom√°tica METAR/TAF + lista de ICAOs"
          file_pattern: dados/*.json
